name: .NET

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      project: Photino.NET/Photino.NET.csproj
      nugetFolder: ./nuget
      configuration: Debug

    steps:
    - run: |
        echo ${{ env.project }}
        echo ${{ env.nugetFolder }}
        echo ${{ env.configuration }}

    - uses: actions/checkout@v2

    - name: Unshallow Fetch
      run: git fetch --unshallow

    - name: Setup .NET 3.0.x
      uses: actions/setup-dotnet@v1
      env:
        NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        dotnet-version: 3.0.x
        source-url: 'https://nuget.pkg.github.com/sharpninja/index.json'

    - name: Setup .NET 5.0.x
      uses: actions/setup-dotnet@v1
      env:
        NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        dotnet-version: 5.0.x
        source-url: 'https://nuget.pkg.github.com/sharpninja/index.json'

    - name: Set API Key
      run: |
        dotnet nuget sources add -name "GPR" -Source ${{ env.source-url }} -Username sharpninja -Password ${{ secrets.GITHUB_TOKEN }}
#        dotnet new tool-manifest
#        dotnet tool install gpr --local
#        dotnet gpr setApiKey ${{ secrets.GITHUB_TOKEN }} ${{ env.nugetRepository }}

    - name: Build, Pack and Publish to GitHub
      run: |        
        mkdir ${{ env.nugetFolder }}
        
        dotnet restore ${{ env.project }}
        
        dotnet pack --configuration ${{ env.configuration }} --no-restore --include-symbols --include-source --output ${{ env.nugetFolder }} ${{ env.project }}
        
        ls -l ${{ env.nugetFolder }} 

        nuget push ${{ env.nugetFolder }}/*.nupkg -source "GPR" -SkipDuplicate
        
#        dotnet gpr push ${{ env.nugetFolder }}/*.nupkg
        
#        dotnet nuget push ${{ env.nugetFolder }}/*.nupkg --skip-duplicate --no-symbols true
        
#        nuget source Add -Name "GitHub" -Source ${{ env.nugetRepository }}
#        nuget setApiKey ${{ env.token }} -src ${{ env.nugetRepository }}  
#        nuget push ${{ env.nugetFolder }}/*.nupkg -src "GitHub"
        